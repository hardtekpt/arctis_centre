import { type WheelEvent, useEffect, useMemo, useRef, useState } from "react";

interface ChannelRowProps {
  channel: string;
  volume: number;
  muted: boolean;
  selectedPreset: string | null;
  presets: Array<[string, string]>;
  apps: string[];
  onVolumeCommit: (value: number) => void;
  onMuteChange: (value: boolean) => void;
  onPresetChange: (presetId: string) => void;
}

function VolumeIcon({ muted }: { muted: boolean }) {
  if (muted) {
    return (
      <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
        <path d="M3 9h4l5-4v14l-5-4H3z" fill="currentColor" />
        <path d="M16 9l5 5M21 9l-5 5" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
      </svg>
    );
  }
  return (
    <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
      <path d="M3 9h4l5-4v14l-5-4H3z" fill="currentColor" />
      <path d="M16 9a4.5 4.5 0 0 1 0 6M18.5 7a8 8 0 0 1 0 10" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
    </svg>
  );
}

export default function ChannelRow(props: ChannelRowProps) {
  const [draftVolume, setDraftVolume] = useState(props.volume);
  const wheelCommitTimer = useRef<number | null>(null);
  const selectRef = useRef<HTMLSelectElement | null>(null);
  const pendingWheelVolume = useRef<number>(props.volume);
  useEffect(() => setDraftVolume(props.volume), [props.volume]);
  useEffect(() => {
    pendingWheelVolume.current = props.volume;
  }, [props.volume]);
  useEffect(
    () => () => {
      if (wheelCommitTimer.current !== null) {
        window.clearTimeout(wheelCommitTimer.current);
      }
    },
    [],
  );
  const appText = useMemo(() => (props.apps.length ? props.apps.join(", ") : "-"), [props.apps]);
  const verticalProgressStyle = useMemo(
    () => ({ height: `${Math.max(0, Math.min(100, draftVolume))}%` }),
    [draftVolume],
  );

  const commitVolume = () => {
    const next = Math.max(0, Math.min(100, draftVolume));
    if (next !== props.volume) props.onVolumeCommit(next);
  };

  const onWheelSlider = (event: WheelEvent<HTMLDivElement>) => {
    event.preventDefault();
    const delta = event.deltaY < 0 ? 1 : -1;
    setDraftVolume((prev) => {
      const next = Math.max(0, Math.min(100, prev + delta));
      pendingWheelVolume.current = next;
      return next;
    });
    if (wheelCommitTimer.current !== null) {
      window.clearTimeout(wheelCommitTimer.current);
    }
    wheelCommitTimer.current = window.setTimeout(() => {
      props.onVolumeCommit(pendingWheelVolume.current);
      wheelCommitTimer.current = null;
    }, 85);
  };

  const channelLabel = useMemo(() => {
    if (props.channel === "chatRender") return "CHAT";
    if (props.channel === "chatCapture") return "MIC";
    if (props.channel === "master") return "MASTER";
    return props.channel.toUpperCase();
  }, [props.channel]);

  const selectedPresetLabel = useMemo(() => {
    if (!props.selectedPreset) return "";
    const found = props.presets.find(([id]) => id === props.selectedPreset);
    return found?.[1] ?? "";
  }, [props.presets, props.selectedPreset]);

  useEffect(() => {
    const el = selectRef.current;
    if (!el || !selectedPresetLabel) return;
    el.scrollLeft = 0;
    const overflow = el.scrollWidth - el.clientWidth;
    if (overflow <= 4) return;
    let dir = 1;
    const tick = window.setInterval(() => {
      const next = el.scrollLeft + dir;
      if (next >= overflow) dir = -1;
      if (next <= 0) dir = 1;
      el.scrollLeft = Math.max(0, Math.min(overflow, next));
    }, 40);
    return () => window.clearInterval(tick);
  }, [selectedPresetLabel]);

  return (
    <div className="channel-row">
      <div className="channel-card-title">{channelLabel}</div>
      <div className="vertical-slider-wrap" onWheel={onWheelSlider}>
        <div className="vertical-track">
          <div className="vertical-progress" style={verticalProgressStyle} />
        </div>
        <input
          type="range"
          min={0}
          max={100}
          value={draftVolume}
          onChange={(e) => setDraftVolume(Number(e.currentTarget.value))}
          onMouseUp={commitVolume}
          onTouchEnd={commitVolume}
          onKeyUp={commitVolume}
          className="vertical-range"
        />
      </div>
      <div className="channel-value">{draftVolume}%</div>
      <button className={`mute-toggle ${props.muted ? "is-muted" : ""}`} onClick={() => props.onMuteChange(!props.muted)} title="Toggle mute">
        <VolumeIcon muted={props.muted} />
      </button>
      {props.channel !== "master" && (
        <select
          ref={selectRef}
          title={selectedPresetLabel}
          value={props.selectedPreset ?? ""}
          onChange={(e) => {
            if (e.currentTarget.value) props.onPresetChange(e.currentTarget.value);
          }}
        >
          <option value="">Preset</option>
          {props.presets.map(([id, name]) => (
            <option key={id} value={id}>
              {name}
            </option>
          ))}
        </select>
      )}
      {props.channel === "master" && <div className="preset-placeholder" />}
      <div className="apps" title={appText}>
        {appText}
      </div>
    </div>
  );
}
